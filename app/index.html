<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essentia DAW Analysis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #09090b;
            /* Zinc 950 */
            --panel: #18181b;
            /* Zinc 900 */
            --border: #27272a;
            /* Zinc 800 */
            --accent: #3b82f6;
            /* Blue 500 */
            --accent-dim: #1d4ed8;
            /* Blue 700 */
            --text: #f4f4f5;
            --text-dim: #a1a1aa;
            --onset: #22c55e;
            --grid-line: rgba(255, 255, 255, 0.1);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        header {
            text-align: center;
            margin-bottom: 1rem;
        }

        h1 {
            font-size: 2rem;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 0.25rem;
        }

        p.subtitle {
            color: var(--text-dim);
            font-size: 1rem;
        }

        /* Drop Zone */
        .drop-zone {
            background: var(--panel);
            border: 2px dashed var(--border);
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .drop-zone:hover {
            border-color: var(--accent);
            background: rgba(59, 130, 246, 0.05);
            /* Blue tint */
        }

        /* DAW Layout */
        #daw-interface {
            display: none;
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        /* Top Bar: Transport */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: #121215;
            border-bottom: 1px solid var(--border);
        }

        .transport-controls {
            display: flex;
            gap: 0.5rem;
        }

        button.btn-icon {
            background: #27272a;
            color: var(--text);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
        }

        button.btn-icon:hover {
            background: #3f3f46;
        }

        button.btn-icon.primary {
            background: var(--accent);
            color: white;
        }

        button.btn-icon.primary:hover {
            background: var(--accent-dim);
        }

        .center-display {
            display: flex;
            gap: 2rem;
            align-items: center;
        }

        .lcd-panel {
            background: #000;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            border: 1px solid #333;
            font-family: monospace;
            color: var(--accent);
            font-size: 1.1rem;
            min-width: 80px;
            text-align: center;
        }

        .lcd-label {
            font-size: 0.6rem;
            color: #666;
            margin-right: 0.5rem;
            text-transform: uppercase;
        }

        .right-controls {
            display: flex;
            gap: 1.5rem;
            align-items: center;
        }

        .slider-control {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .slider-control label {
            font-size: 0.6rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        input[type="range"] {
            width: 100px;
            height: 4px;
            accent-color: var(--accent);
        }

        /* DAW Body: Track Layout */
        .daw-body {
            display: flex;
            position: relative;
        }

        .track-header {
            width: 200px;
            background: #18181b;
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 0.5rem;
            justify-content: center;
            flex-shrink: 0;
        }

        .track-info {
            background: #27272a;
            border-radius: 4px;
            padding: 0.5rem;
            border-left: 4px solid var(--accent);
        }

        .track-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .track-controls {
            display: flex;
            gap: 0.25rem;
        }

        .btn-tiny {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: #3f3f46;
            color: #ccc;
            border: none;
            border-radius: 2px;
            cursor: default;
            /* Visual only */
        }

        .btn-tiny.dull {
            opacity: 0.5;
        }

        .timeline-area {
            flex-grow: 1;
            position: relative;
            background: #09090b;
            min-height: 180px;
            overflow: hidden;
            /* WaveSurfer handles scroll */
        }

        /* WaveSurfer Overrides */
        #waveform {
            height: 100%;
            width: 100%;
        }

        /* Regions Styling */
        .wavesurfer-region {
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
            font-size: 10px !important;
            font-weight: 600 !important;
            padding: 2px !important;
            text-transform: uppercase;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        /* Grid & Markers as overlay */
        .grid-line {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 1px;
            background: var(--grid-line);
            pointer-events: none;
            z-index: 10;
        }

        .marker-tick {
            position: absolute;
            bottom: 0;
            width: 1px;
            background: var(--onset);
            pointer-events: none;
            z-index: 20;
        }

        /* Bottom Stats Panel */
        .stats-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1px;
            background: var(--border);
            /* Borders via gap */
            margin-top: 1.5rem;
            border-radius: 0.5rem;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .stat-col {
            background: var(--panel);
            padding: 1.5rem;
        }

        .stat-col h3 {
            font-size: 0.75rem;
            text-transform: uppercase;
            color: var(--text-dim);
            margin-bottom: 1rem;
            letter-spacing: 0.05em;
        }

        .stat-list {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .stat-unit {
            display: flex;
            flex-direction: column;
        }

        .stat-unit label {
            font-size: 0.7rem;
            color: #52525b;
            margin-bottom: 0.2rem;
            text-transform: uppercase;
        }

        .stat-unit span {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text);
        }

        .text-blue {
            color: #60a5fa !important;
        }

        .text-green {
            color: #4ade80 !important;
        }

        /* CUE LED */
        .led {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #333;
            margin: 0 auto;
            border: 1px solid #444;
            transition: all 0.05s;
        }

        .led.active {
            background: #06b6d4;
            box-shadow: 0 0 8px #06b6d4;
            border-color: white;
        }

        /* Loading */
        .spinner {
            display: none;
            width: 30px;
            height: 30px;
            border: 3px solid #333;
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 1rem auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        #status {
            text-align: center;
            color: var(--accent);
            margin-top: 0.5rem;
            font-size: 0.9rem;
        }
    </style>
</head>

<body>
    <div class="container">

        <header>
            <h1>Essentia DAW</h1>
            <p class="subtitle">Timeline, Grid & AI Classification</p>
        </header>

        <div id="setup-panel">
            <div id="drop-zone" class="drop-zone">
                <p>Drag & Drop Audio File</p>
                <input type="file" id="file-input" hidden accept="audio/*">
            </div>
            <div id="loading" class="spinner"></div>
            <div id="status"></div>
        </div>

        <div id="daw-interface">
            <!-- Top Controls -->
            <div class="top-bar">
                <div class="transport-controls">
                    <button id="prev-btn" class="btn-icon" title="Prev Marker">⏮</button>
                    <button id="play-btn" class="btn-icon primary" title="Play">▶</button>
                    <button id="next-btn" class="btn-icon" title="Next Marker">⏭</button>
                </div>

                <div class="center-display">
                    <div>
                        <span class="lcd-label">BPM</span>
                        <div class="lcd-panel" id="lcd-bpm">--</div>
                    </div>
                    <div>
                        <span class="lcd-label">KEY</span>
                        <div class="lcd-panel" id="lcd-key" style="color: #c084fc;">--</div>
                    </div>
                    <div style="text-align: center;">
                        <span class="lcd-label">CUE</span>
                        <div id="cue-led" class="led" style="margin-top: 5px;"></div>
                    </div>
                </div>

                <div class="right-controls">
                    <div class="slider-control">
                        <label>Markers</label>
                        <input type="range" id="density-slider" min="0" max="100" value="50">
                    </div>
                    <div class="slider-control">
                        <label>Zoom</label>
                        <input type="range" id="zoom-slider" min="10" max="300" value="50">
                    </div>
                </div>
            </div>

            <!-- Main Track Area -->
            <div class="daw-body">
                <div class="track-header">
                    <div class="track-info">
                        <div class="track-name" id="track-name">Audio Track 1</div>
                        <div class="track-controls">
                            <button class="btn-tiny dull">M</button>
                            <button class="btn-tiny dull">S</button>
                            <span style="font-size: 0.6rem; color: #666; margin-left: auto;">Vol: 0.0</span>
                        </div>
                    </div>
                </div>

                <div class="timeline-area">
                    <div id="waveform"></div>
                    <!-- Grid & Markers injected here -->
                </div>
            </div>
        </div>

        <!-- Detailed Stats (Bottom) -->
        <div id="stats-panel" class="stats-panel" style="display: none;">
            <div class="stat-col">
                <h3>Rhythm & Timing</h3>
                <div class="stat-list">
                    <div class="stat-unit"><label>Onsets</label><span id="stat-onsets">--</span></div>
                    <div class="stat-unit"><label>Duration</label><span id="stat-duration">--</span></div>
                    <div class="stat-unit"><label>Sections</label><span id="stat-sections">--</span></div>
                </div>
            </div>
            <div class="stat-col">
                <h3>Tonal Analysis</h3>
                <div class="stat-list">
                    <div class="stat-unit"><label>Key</label><span class="text-blue" id="stat-key">--</span></div>
                    <div class="stat-unit"><label>Scale</label><span id="stat-scale">--</span></div>
                    <div class="stat-unit"><label>Strength</label><span id="stat-strength">--</span></div>
                </div>
            </div>
            <div class="stat-col">
                <h3>Classification</h3>
                <div class="stat-list">
                    <div class="stat-unit"><label>Genre</label><span class="text-green" id="stat-genre">--</span></div>
                    <div class="stat-unit"><label>Mood</label><span id="stat-mood">--</span></div>
                </div>
                <div style="margin-top: 1rem;"><span id="stat-tags" style="font-size: 0.8rem; color: #666;">--</span>
                </div>
            </div>
        </div>

    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/wavesurfer.js@7/dist/wavesurfer.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
    <script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/timeline.min.js"></script>

    <script>
        const API_BASE = window.location.origin.includes('localhost') || window.location.origin.includes('127.0.0.1')
            ? 'http://localhost:8000'
            : 'https://essentia.v1su4.com';

        // ELs
        const els = {
            dropZone: document.getElementById('drop-zone'),
            fileInput: document.getElementById('file-input'),
            loading: document.getElementById('loading'),
            status: document.getElementById('status'),
            dawInterface: document.getElementById('daw-interface'),
            statsPanel: document.getElementById('stats-panel'),
            playBtn: document.getElementById('play-btn'),
            prevBtn: document.getElementById('prev-btn'),
            nextBtn: document.getElementById('next-btn'),
            cueLed: document.getElementById('cue-led'),
            densitySlider: document.getElementById('density-slider'),
            zoomSlider: document.getElementById('zoom-slider'),
            trackName: document.getElementById('track-name')
        };

        let ws, wsRegions, wsTimeline;
        let analysisData = null;
        let activeMarkers = [];
        let isPlaying = false;
        let zoomLevel = 50;

        // Init
        function initWaveSurfer(url) {
            if (ws) ws.destroy();

            wsRegions = WaveSurfer.Regions.create();
            wsTimeline = WaveSurfer.Timeline.create({
                height: 20,
                timeInterval: 0.1,
                primaryLabelInterval: 1,
                style: { fontSize: '10px', color: '#555' }
            });

            ws = WaveSurfer.create({
                container: '#waveform',
                waveColor: '#3b82f6',     // Vibrant Blue
                progressColor: '#1e40af', // Darker Blue
                cursorColor: '#ffffff',
                height: 'auto',           // Fill container
                barWidth: 2,
                barGap: 1,
                barRadius: 2,
                normalize: true,
                minPxPerSec: 50,
                plugins: [wsRegions, wsTimeline]
            });

            ws.load(url);

            ws.on('ready', () => {
                els.dawInterface.style.display = 'block';
                els.statsPanel.style.display = 'grid';
                els.status.style.display = 'none';
                ws.zoom(Number(els.zoomSlider.value));
            });

            ws.on('zoom', () => {
                // Re-draw grid on zoom (Debounce technically handling this via frame request would be better)
                requestAnimationFrame(() => drawGridLOD());
            });

            ws.on('play', () => { isPlaying = true; els.playBtn.innerText = '⏸'; loop(); });
            ws.on('pause', () => { isPlaying = false; els.playBtn.innerText = '▶'; });
            ws.on('finish', () => { isPlaying = false; els.playBtn.innerText = '▶'; });
        }

        // Loop for Visuals
        function loop() {
            if (!isPlaying) return;
            const time = ws.getCurrentTime();

            // LED Logic
            const hit = activeMarkers.some(t => Math.abs(t - time) < 0.05);
            if (hit) {
                els.cueLed.classList.add('active');
                setTimeout(() => els.cueLed.classList.remove('active'), 80);
            }
            requestAnimationFrame(loop);
        }

        // Controls
        els.playBtn.onclick = () => ws.playPause();
        els.zoomSlider.oninput = (e) => {
            zoomLevel = Number(e.target.value);
            ws.zoom(zoomLevel);
        };
        els.densitySlider.oninput = (e) => {
            if (analysisData) updateMarkers(e.target.value);
        };
        els.nextBtn.onclick = () => seekToMarker(1);
        els.prevBtn.onclick = () => seekToMarker(-1);

        function seekToMarker(dir) {
            if (!activeMarkers.length) return;
            const t = ws.getCurrentTime();
            // Find closest
            const target = dir > 0
                ? activeMarkers.find(mx => mx > t + 0.1)
                : [...activeMarkers].reverse().find(mx => mx < t - 0.1);

            if (target) ws.seekTo(target / ws.getDuration());
            else if (dir < 0) ws.seekTo(0);
        }

        // File
        els.dropZone.onclick = () => els.fileInput.click();
        els.fileInput.onchange = (e) => { if (e.target.files.length) loadFile(e.target.files[0]); };

        async function loadFile(file) {
            els.loading.style.display = 'block';
            els.status.innerText = 'Uploading & Analyzing...';
            els.status.style.display = 'block';
            els.trackName.innerText = file.name;

            const url = URL.createObjectURL(file);
            initWaveSurfer(url);

            const fd = new FormData();
            fd.append('file', file);

            try {
                const res = await fetch(`${API_BASE}/analyze/full`, { method: 'POST', body: fd });
                if (!res.ok) throw new Error("API Error");
                analysisData = await res.json();
                renderData(analysisData);
                els.status.innerText = "";
            } catch (e) {
                console.error(e);
                els.status.innerText = "Error: " + e.message;
            } finally {
                els.loading.style.display = 'none';
            }
        }

        function renderData(data) {
            // LCD
            document.getElementById('lcd-bpm').innerText = data.bpm ? Math.round(data.bpm) : '--';
            document.getElementById('lcd-key').innerText = data.tonal?.key || '--';

            // Stats Panel
            document.getElementById('stat-onsets').innerText = data.onsets?.length || 0;
            document.getElementById('stat-duration').innerText = Math.round(data.duration) + 's';
            document.getElementById('stat-sections').innerText = data.structure?.sections?.length || 0;

            document.getElementById('stat-key').innerText = data.tonal?.key || '--';
            document.getElementById('stat-scale').innerText = data.tonal?.scale || '--';
            document.getElementById('stat-strength').innerText = Math.round((data.tonal?.strength || 0) * 100) + '%';

            document.getElementById('stat-genre').innerText = data.classification?.genres?.label || 'N/A';
            document.getElementById('stat-mood').innerText = data.classification?.moods?.label || 'N/A';
            document.getElementById('stat-tags').innerText = (data.classification?.tags || []).slice(0, 5).join(', ');

            // Regions (Vibrant Blocks)
            wsRegions.clearRegions();
            const colorMap = {
                'intro': 'rgba(239, 68, 68, 0.4)', // Red
                'verse': 'rgba(59, 130, 246, 0.4)', // Blue
                'chorus': 'rgba(168, 85, 247, 0.4)', // Purple
                'outro': 'rgba(107, 114, 128, 0.4)', // Gray
                'bridge': 'rgba(245, 158, 11, 0.4)'  // Amber
            };

            if (data.structure?.sections) {
                data.structure.sections.forEach(s => {
                    wsRegions.addRegion({
                        start: s.start, end: s.end,
                        content: s.label.toUpperCase(),
                        color: colorMap[s.label] || 'rgba(16, 185, 129, 0.4)', // Default Green
                        drag: false, resize: false
                    });
                });
            }

            // Init Markers
            updateMarkers(50);

            // Initial Grid
            drawGridLOD();
        }

        // --- GRID LOD LOGIC ---
        function drawGridLOD() {
            if (!analysisData || !analysisData.bpm) return;

            // Cleanup old lines
            const container = document.querySelector('#waveform');
            const old = container.querySelectorAll('.grid-line');
            old.forEach(el => el.remove());

            // Calculate pxPerBeat based on ZOOM
            // WaveSurfer pixel ratio depends on container width vs duration
            // We can get pxPerSec from WS wrapper or approximate.
            // Better: use WS internal wrapper width.
            const wrapper = container.querySelector('div'); // WS container
            if (!wrapper) return;

            const pxPerSec = wrapper.scrollWidth / analysisData.duration;
            const singleBeatDuration = 60 / analysisData.bpm;
            const pxPerBeat = pxPerSec * singleBeatDuration;

            // Determine subdivision
            // We want nice spacing, e.g. at least 15px between lines.
            // 4/4 assumed.
            let div = 1; // Quarter notes
            if (pxPerBeat > 30) div = 2;   // 8th
            if (pxPerBeat > 60) div = 4;   // 16th
            if (pxPerBeat > 120) div = 8;  // 32nd
            if (pxPerBeat < 10) div = 0.25; // Bars (1/1)

            const interval = singleBeatDuration / div;

            // Fragment for perf
            const frag = document.createDocumentFragment();
            for (let t = 0; t < analysisData.duration; t += interval) {
                const l = document.createElement('div');
                l.className = 'grid-line';
                l.style.left = (t / analysisData.duration * 100) + '%';

                // Styling based on beat strength using modulo
                // Use tiny epsilon for float comparison
                const beatPos = t % (singleBeatDuration * 4); // Position in Bar (4 beats)

                // Bar line (Strongest)
                if (Math.abs(t % (singleBeatDuration * 4)) < 0.01) {
                    l.style.background = 'rgba(255,255,255,0.3)';
                }
                // Beat line
                else if (Math.abs(t % singleBeatDuration) < 0.01) {
                    l.style.background = 'rgba(255,255,255,0.15)';
                }
                // Sub-beat
                else {
                    l.style.background = 'rgba(255,255,255,0.05)';
                }

                frag.appendChild(l);
            }
            container.appendChild(frag);
        }

        function updateMarkers(density) {
            const container = document.querySelector('#waveform');
            container.querySelectorAll('.marker-tick').forEach(e => e.remove());

            if (!analysisData) return;

            letToShow = [];
            if (density > 0) {
                const step = Math.max(1, Math.round(100 / density));
                letToShow = analysisData.onsets.filter((_, i) => i % step === 0);
            }
            activeMarkers = letToShow;

            const frag = document.createDocumentFragment();
            letToShow.forEach(t => {
                const el = document.createElement('div');
                el.className = 'marker-tick';
                el.style.left = (t / analysisData.duration * 100) + '%';
                el.style.height = '15%';
                frag.appendChild(el);
            });
            container.appendChild(frag);
        }

    </script>
</body>

</html>